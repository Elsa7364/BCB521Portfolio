---
title: "Wateromics 2015"
author: "Marwa Elsayed"
date: "2023-10-10"
categories: [Assignments, Data Description]
output: 
  html_document:
    code_folding: hide
---

For this assignment, we will explore how water consumption varies by median household income across U.S. counties for the year 2015, on a per capita basis.

Focusing on three sectors: domestic, industrial, and irrigation. The research question is: How is 2015 per capita water use in domestic, industrial, and irrigation sectors correlated with median household income across U.S. counties?

**The plan is as follows:**

1.  Segment water use data by sector (domestic, industrial, irrigation).

2.  Extract median household income and population data.

3.  Merge datasets.

4.  Compute per capita water use for each sector.

5.  Conduct correlation analysis between per capita water use and median household income across sectors.

For water data, [here](https://www.sciencebase.gov/catalog/item/get/5af3311be4b0da30c1b245d8) For income data, [Census Data on Income and Poverty](https://data.census.gov/table/ACSST1Y2015.S1903?t=Income+and+Poverty&g=010XX00US,$0500000&y=2015)

## Reading the Datasets

```{r}
library(tidyverse) 
library(readxl) 
```

```{r}
waterusage <- read.csv("usco2015v2.0.csv", skip = 1)
waterdatadictionary <- read_excel("usco2015v2.0.xlsx", sheet = "DataDictionary") 
incomedata <- read.csv("ACSST1Y2015.S1903-Data.csv", skip = 1)
```

## **Segment Water Use Data by Sector**

### Relevant Variables to Domestic Use:

1.  **DO.WFrTo**: The total self-supplied withdrawals, which is a comprehensive measure of domestic water use without public supply.

2.  **DO.SSPCp**: This is the per capita self-supplied water use. It's already normalized by population and will be useful for direct comparisons.

3.  **DO.PSPCp**: This is the per capita use for publicly supplied water, another useful metric when normalized by population.

4.  **DO.WDelv**: This is the total use, which includes both withdrawals and deliveries. It's the most comprehensive measure of water use at the domestic level.

    Depending on the granularity of the analysis, we can either focus on the most comprehensive measure (DO-WDelv) or break it down to see if self-supplied vs. publicly supplied makes a difference in the correlation with income (DO-SSPCp and DO-PSPCp).

```{r}
domestic_data <- waterusage %>%
  select(STATE, STATEFIPS, COUNTY, COUNTYFIPS, FIPS, YEAR, `TP.TotPop`, 
         `DO.WFrTo`, `DO.SSPCp`, `DO.PSPCp`, `DO.WDelv`)
# rename the columns to something more descriptive
domestic_data <- domestic_data %>%
  rename(
    State_Abbrev = STATE,
    State_FIPS = STATEFIPS,
    County_Name = COUNTY,
    County_FIPS = COUNTYFIPS,
    State_County_FIPS = FIPS,
    Data_Year = YEAR,
    Total_Population = `TP.TotPop`,
    Domestic_Total_Self_Supplied = `DO.WFrTo`,
    Domestic_Per_Capita_Self_Supplied = `DO.SSPCp`,
    Domestic_Per_Capita_Publicly_Supplied = `DO.PSPCp`,
    Domestic_Total_Use = `DO.WDelv`
  )
```

### Relevant Variables to Industrial Use:

1.  IN.WGWTo: This gives you the total self-supplied groundwater withdrawals, both fresh and saline. It will provide a comprehensive look at groundwater use.

2.  IN.WSWTo: Similarly, this variable gives you the total self-supplied surface-water withdrawals, including both fresh and saline water. This will cover all surface-water usage.

3.  IN.Wtotl: This is the most comprehensive measure that includes both groundwater and surface-water, fresh and saline. It gives you a full picture of industrial water use.

    ```{r}
    industrial_data <- waterusage %>%
      select(STATE, STATEFIPS, COUNTY, COUNTYFIPS, FIPS, YEAR,`TP.TotPop`,
             `IN.WGWTo`, `IN.WSWTo`, `IN.Wtotl`)
    # rename the columns to something more descriptive
    industrial_data <- industrial_data %>%
      rename(
        State_Abbrev = STATE,
        State_FIPS = STATEFIPS,
        County_Name = COUNTY,
        County_FIPS = COUNTYFIPS,
        State_County_FIPS = FIPS,
        Data_Year = YEAR,
        Total_Population = `TP.TotPop`,
        Industrial_Total_Groundwater = `IN.WGWTo`,
        Industrial_Total_SurfaceWater = `IN.WSWTo`,
        Industrial_Total_Water = `IN.Wtotl`
      )
    ```

### Relevant Variables to Irrigation Use:

1.  IR.WFrTo: Total water withdrawals for irrigation, covering both groundwater and surface water, provides a comprehensive metric.

2.  IR.RecWW: This gives an idea of how much reclaimed water is being used, which could be an interesting aspect related to sustainability.

3.  IR.IrTot: This will provide the total acres irrigated, useful for understanding the scale of irrigation in different counties.

4.  IC.WFrTo: If you're also interested in specifying crop irrigation, this variable will be useful. It gives total water withdrawals specifically for crop irrigation.

5.  IG.WFrTo: For irrigation in golf courses, this variable provides total withdrawals and can help in understanding non-agricultural irrigation demands.

    ```{r}
    irrigation_data <- waterusage %>%
      select(STATE, STATEFIPS, COUNTY, COUNTYFIPS, FIPS, YEAR, `TP.TotPop`,
             `IR.WFrTo`, `IR.RecWW`, `IR.IrTot`, `IC.WFrTo`, `IG.WFrTo`)
    # renaming columns for better readability
    irrigation_data <- irrigation_data %>%
      rename(
        State_Abbrev = STATE,
        State_FIPS = STATEFIPS,
        County_Name = COUNTY,
        County_FIPS = COUNTYFIPS,
        State_County_FIPS = FIPS,
        Data_Year = YEAR,
        Total_Population = `TP.TotPop`,
        Total_Irrigation_Withdrawal = `IR.WFrTo`,
        Reclaimed_Water_Irrigation = `IR.RecWW`,
        Total_Acres_Irrigated = `IR.IrTot`,
        Crop_Irrigation_Withdrawal = `IC.WFrTo`,
        Golf_Irrigation_Withdrawal = `IG.WFrTo`
      )
    ```

## **Income and Demographic Dataset**

Choosing the relevant variables for merging and analysis

1.  Geography: The field labeled 'Geography' contains coded identifiers for different locations.

2.  Geographic.Area.Name: This could be useful for merging the datasets based on location.

3.  Median.income..dollars...Estimate..Households: This variable provides the median income, which is a mian point in the research question.

    ```{r}
    # selecting relevant variables from the income data
    selected_incomedata <- incomedata %>%
      select(Geography, Geographic.Area.Name, `Median.income..dollars...Estimate..Households`)

    # cleaning the Geographic.Area.Name to remove the state name and comma
    selected_incomedata$Geographic.Area.Name <- gsub(",.*$", "", selected_incomedata$Geographic.Area.Name)

    # renaming columns for better readability
    selected_incomedata <- selected_incomedata %>%
      rename(
        State_County_FIPS = Geography,
        AreaName = Geographic.Area.Name,
        MedianHouseholdIncome = `Median.income..dollars...Estimate..Households`
      )
    # remove prefix and extract relevant FIPS from the GeoCode, The ? in the regular expression makes the last "0" optional
    library(stringr)
    selected_incomedata$State_County_FIPS <- str_replace_all(selected_incomedata$State_County_FIPS, "0500000US0?", "")
    ```

## Integrity checks before merging

```{r}
# since I will be using State_County_Fips for mergeing, it will be used for the the integrity checks

# checking missing values
sapply(list(domestic_data, selected_incomedata, industrial_data, irrigation_data), function(df) sum(is.na(df$State_County_FIPS)))

# checking for duplicates
sapply(list(domestic_data, selected_incomedata, industrial_data, irrigation_data), function(df) anyDuplicated(df$State_County_FIPS))

# checking for consistency in datatype
str(domestic_data$State_County_FIPS)
str(selected_incomedata$State_County_FIPS)
str(industrial_data$State_County_FIPS)
str(irrigation_data$State_County_FIPS)

#addressing the incosistency to make it all integers
selected_incomedata$State_County_FIPS <- as.integer(selected_incomedata$State_County_FIPS)

```

## Merging the data

```{r}
merged_data <- domestic_data %>%
  inner_join(selected_incomedata, by = "State_County_FIPS") %>%
  inner_join(industrial_data, by = "State_County_FIPS") %>%
  inner_join(irrigation_data, by = "State_County_FIPS")
```

## Graphs

```{r}

```
